# Prometheus Configuration for LLM Share Network

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'llm-share-network'
    environment: 'production'

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

rule_files:
  - "/etc/prometheus/rules/*.yml"

scrape_configs:
  # Prometheus 自身监控
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'

  # API Gateway 监控
  - job_name: 'api-gateway'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['api-gateway:8080']
        labels:
          service: 'api-gateway'
          component: 'gateway'
    scrape_interval: 10s

  # Provider Node 监控
  - job_name: 'provider-node'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['provider-node-1:8080', 'provider-node-2:8080', 'provider-node-3:8080']
        labels:
          service: 'provider-node'
          component: 'worker'
    scrape_interval: 10s

  # Node Exporter - 系统指标
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          service: 'node-exporter'
          component: 'system'

  # Cadvisor - 容器指标
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          service: 'cadvisor'
          component: 'container'

  # Blackbox Exporter - URL 监控
  - job_name: 'blackbox'
    metrics_path: '/probe'
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - 'http://api-gateway:8080/health'
          - 'http://provider-node-1:8080/health'
    scrape_interval: 30s

# 记录规则 - 预先计算常用查询
recording_rules:
  - name: 'api-gateway:requests'
    rules:
      - record: 'job:api_requests_total:rate5m'
        expr: 'rate(api_requests_total[5m])'
      - record: 'job:api_latency_p99:rate5m'
        expr: 'histogram_quantile(0.99, rate(api_latency_seconds_bucket[5m]))'

  - name: 'provider-node:tasks'
    rules:
      - record: 'job:provider_tasks_total:rate5m'
        expr: 'rate(provider_tasks_total[5m])'
      - record: 'job:provider_task_duration_p99:rate5m'
        expr: 'histogram_quantile(0.99, rate(provider_task_duration_seconds_bucket[5m]))'

  - name: 'system:resources'
    rules:
      - record: 'instance:cpu_usage:rate5m'
        expr: '100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)'
      - record: 'instance:memory_usage_percent'
        expr: '100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes))'
      - record: 'instance:disk_usage_percent'
        expr: '100 * (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})'
